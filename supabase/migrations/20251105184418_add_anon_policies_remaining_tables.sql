/*\n  # Add Anon Policies for Remaining Tables\n\n  ## Problem\n  The Supabase client uses the anon role even for authenticated users.\n  We need anon policies for all tables.\n\n  ## Tables to update\n  - trip_members (add missing policies)\n  - days\n  - activities  \n  - polls\n  - poll_options\n  - poll_votes\n  - messages\n\n  ## Changes\n  Add comprehensive anon policies for all operations\n*/\n\n-- ============================================================================\n-- DAYS\n-- ============================================================================\n\nCREATE POLICY "anon_select_days"\n  ON public.days\n  FOR SELECT\n  TO anon\n  USING (\n    EXISTS (\n      SELECT 1 FROM trips t\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE t.id = days.trip_id\n        AND tm.user_id = auth.uid()\n    )\n  );
\n\nCREATE POLICY "anon_insert_days"\n  ON public.days\n  FOR INSERT\n  TO anon\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM trips t\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE t.id = trip_id\n        AND tm.user_id = auth.uid()\n    )\n  );
\n\nCREATE POLICY "anon_update_days"\n  ON public.days\n  FOR UPDATE\n  TO anon\n  USING (\n    EXISTS (\n      SELECT 1 FROM trips t\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE t.id = trip_id\n        AND tm.user_id = auth.uid()\n    )\n  )\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM trips t\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE t.id = trip_id\n        AND tm.user_id = auth.uid()\n    )\n  );
\n\nCREATE POLICY "anon_delete_days"\n  ON public.days\n  FOR DELETE\n  TO anon\n  USING (\n    EXISTS (\n      SELECT 1 FROM trips t\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE t.id = trip_id\n        AND tm.user_id = auth.uid()\n    )\n  );
\n\n-- ============================================================================\n-- ACTIVITIES\n-- ============================================================================\n\nCREATE POLICY "anon_select_activities"\n  ON public.activities\n  FOR SELECT\n  TO anon\n  USING (\n    EXISTS (\n      SELECT 1 FROM days d\n      JOIN trips t ON t.id = d.trip_id\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE d.id = activities.day_id\n        AND tm.user_id = auth.uid()\n    )\n  );
\n\nCREATE POLICY "anon_insert_activities"\n  ON public.activities\n  FOR INSERT\n  TO anon\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM days d\n      JOIN trips t ON t.id = d.trip_id\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE d.id = day_id\n        AND tm.user_id = auth.uid()\n    )\n  );
\n\nCREATE POLICY "anon_update_activities"\n  ON public.activities\n  FOR UPDATE\n  TO anon\n  USING (\n    EXISTS (\n      SELECT 1 FROM days d\n      JOIN trips t ON t.id = d.trip_id\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE d.id = day_id\n        AND tm.user_id = auth.uid()\n    )\n  )\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM days d\n      JOIN trips t ON t.id = d.trip_id\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE d.id = day_id\n        AND tm.user_id = auth.uid()\n    )\n  );
\n\nCREATE POLICY "anon_delete_activities"\n  ON public.activities\n  FOR DELETE\n  TO anon\n  USING (\n    EXISTS (\n      SELECT 1 FROM days d\n      JOIN trips t ON t.id = d.trip_id\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE d.id = day_id\n        AND tm.user_id = auth.uid()\n    )\n  );
\n\n-- ============================================================================\n-- POLLS\n-- ============================================================================\n\nCREATE POLICY "anon_select_polls"\n  ON public.polls\n  FOR SELECT\n  TO anon\n  USING (\n    EXISTS (\n      SELECT 1 FROM trips t\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE t.id = polls.trip_id\n        AND tm.user_id = auth.uid()\n    )\n  );
\n\nCREATE POLICY "anon_insert_polls"\n  ON public.polls\n  FOR INSERT\n  TO anon\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM trips t\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE t.id = trip_id\n        AND tm.user_id = auth.uid()\n    )\n    AND created_by = auth.uid()\n  );
\n\nCREATE POLICY "anon_update_polls"\n  ON public.polls\n  FOR UPDATE\n  TO anon\n  USING (created_by = auth.uid())\n  WITH CHECK (created_by = auth.uid());
\n\nCREATE POLICY "anon_delete_polls"\n  ON public.polls\n  FOR DELETE\n  TO anon\n  USING (created_by = auth.uid());
\n\n-- ============================================================================\n-- POLL_OPTIONS\n-- ============================================================================\n\nCREATE POLICY "anon_select_poll_options"\n  ON public.poll_options\n  FOR SELECT\n  TO anon\n  USING (\n    EXISTS (\n      SELECT 1 FROM polls p\n      JOIN trips t ON t.id = p.trip_id\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE p.id = poll_options.poll_id\n        AND tm.user_id = auth.uid()\n    )\n  );
\n\nCREATE POLICY "anon_insert_poll_options"\n  ON public.poll_options\n  FOR INSERT\n  TO anon\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM polls p\n      WHERE p.id = poll_id AND p.created_by = auth.uid()\n    )\n  );
\n\n-- ============================================================================\n-- POLL_VOTES\n-- ============================================================================\n\nCREATE POLICY "anon_select_poll_votes"\n  ON public.poll_votes\n  FOR SELECT\n  TO anon\n  USING (\n    EXISTS (\n      SELECT 1 FROM poll_options po\n      JOIN polls p ON p.id = po.poll_id\n      JOIN trips t ON t.id = p.trip_id\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE po.id = poll_votes.option_id\n        AND tm.user_id = auth.uid()\n    )\n  );
\n\nCREATE POLICY "anon_insert_poll_votes"\n  ON public.poll_votes\n  FOR INSERT\n  TO anon\n  WITH CHECK (\n    user_id = auth.uid()\n    AND EXISTS (\n      SELECT 1 FROM poll_options po\n      JOIN polls p ON p.id = po.poll_id\n      JOIN trips t ON t.id = p.trip_id\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE po.id = option_id\n        AND tm.user_id = auth.uid()\n    )\n  );
\n\nCREATE POLICY "anon_delete_poll_votes"\n  ON public.poll_votes\n  FOR DELETE\n  TO anon\n  USING (user_id = auth.uid());
\n\n-- ============================================================================\n-- MESSAGES\n-- ============================================================================\n\nCREATE POLICY "anon_select_messages"\n  ON public.messages\n  FOR SELECT\n  TO anon\n  USING (\n    EXISTS (\n      SELECT 1 FROM trips t\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE t.id = messages.trip_id\n        AND tm.user_id = auth.uid()\n    )\n  );
\n\nCREATE POLICY "anon_insert_messages"\n  ON public.messages\n  FOR INSERT\n  TO anon\n  WITH CHECK (\n    author_id = auth.uid()\n    AND EXISTS (\n      SELECT 1 FROM trips t\n      JOIN trip_members tm ON tm.trip_id = t.id\n      WHERE t.id = trip_id\n        AND tm.user_id = auth.uid()\n    )\n  );
\n\nCREATE POLICY "anon_update_messages"\n  ON public.messages\n  FOR UPDATE\n  TO anon\n  USING (author_id = auth.uid())\n  WITH CHECK (author_id = auth.uid());
\n\nCREATE POLICY "anon_delete_messages"\n  ON public.messages\n  FOR DELETE\n  TO anon\n  USING (author_id = auth.uid());
\n;
