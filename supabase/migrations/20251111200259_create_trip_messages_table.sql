/*\n  # Create Trip Messages Table for Chat\n\n  1. New Tables\n    - `trip_messages`\n      - `id` (uuid, primary key)\n      - `trip_id` (uuid, foreign key to trips)\n      - `author_id` (uuid, foreign key to user_profiles)\n      - `content` (text, message content)\n      - `created_at` (timestamptz, auto-generated)\n  \n  2. Security\n    - Enable RLS on `trip_messages` table\n    - Add policies for trip members to read messages\n    - Add policies for trip members to send messages\n  \n  3. Realtime\n    - Enable realtime replication for live chat updates\n  \n  4. Notes\n    - This table is specifically for trip chat messages\n    - The existing 'messages' table is for internal Supabase realtime use\n    - Foreign keys enable JOIN queries with trips and user_profiles\n*/\n\n-- Create trip_messages table\nCREATE TABLE IF NOT EXISTS public.trip_messages (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  trip_id uuid NOT NULL REFERENCES public.trips(id) ON DELETE CASCADE,\n  author_id uuid NOT NULL REFERENCES public.user_profiles(user_id) ON DELETE CASCADE,\n  content text NOT NULL,\n  created_at timestamptz DEFAULT now()\n);
\n\n-- Create index for faster queries\nCREATE INDEX IF NOT EXISTS trip_messages_trip_id_idx ON public.trip_messages(trip_id);
\nCREATE INDEX IF NOT EXISTS trip_messages_created_at_idx ON public.trip_messages(created_at);
\n\n-- Enable RLS\nALTER TABLE public.trip_messages ENABLE ROW LEVEL SECURITY;
\n\n-- Policy: Trip members can read messages from their trips\nCREATE POLICY "Trip members can read trip messages"\n  ON public.trip_messages\n  FOR SELECT\n  TO authenticated\n  USING (\n    EXISTS (\n      SELECT 1 FROM public.trip_members\n      WHERE trip_members.trip_id = trip_messages.trip_id\n      AND trip_members.user_id = auth.uid()\n    )\n  );
\n\n-- Policy: Trip members can insert messages to their trips\nCREATE POLICY "Trip members can send trip messages"\n  ON public.trip_messages\n  FOR INSERT\n  TO authenticated\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM public.trip_members\n      WHERE trip_members.trip_id = trip_messages.trip_id\n      AND trip_members.user_id = auth.uid()\n    )\n    AND author_id = auth.uid()\n  );
\n\n-- Enable realtime\nALTER PUBLICATION supabase_realtime ADD TABLE trip_messages;
\n\n-- Add comments\nCOMMENT ON TABLE public.trip_messages IS 'Chat messages for trips';
\nCOMMENT ON COLUMN public.trip_messages.trip_id IS 'The trip this message belongs to';
\nCOMMENT ON COLUMN public.trip_messages.author_id IS 'The user who sent this message';
\nCOMMENT ON COLUMN public.trip_messages.content IS 'The message content';
\n;
